API DOCUMENTATION 
# WhatsApp Registration API - Documentation

**Version:** 1.0.0  
**Status:** Ready for Testing  
**Last Updated:** November 18, 2025

---

## Important: API Base URL

**The API base URL will depend on how you're testing:**

### Option A: Remote Testing (Recommended)
When you're ready to test, I'll provide you with a live URL. This allows testing from anywhere with no setup required on your end.

### Option B: Local Setup
If you prefer to run it locally:
- Base URL: `http://localhost:3000`
- Requires running the provided code on your machine
- See Setup Guide for installation instructions

**Contact me when ready, and I'll provide the active base URL for Option A.**

---

## Quick Start Guide

### Prerequisites
- Phone numbers that can receive SMS (for WhatsApp verification)
- HTTP client (curl, Postman, or the provided PowerShell script)

### Basic Flow
1. **Register** - Initiate WhatsApp registration with a phone number
2. **Check Status** - Wait approximately 90 seconds, confirm it's ready for OTP
3. **Submit OTP** - Enter the 6-digit code from SMS
4. **Verify Success** - Confirm registration completed

**Total time per account:** 2-3 minutes

---

## Complete Registration Flow

### Step 1: Start Registration

**Endpoint:** `POST /whatsapp/register`

**Request Body:**
```json
{
  "phoneNumber": "+1234567890"
}
```

**Parameters:**

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| phoneNumber | string | Yes | Full phone number with country code (E.164 format) |
| countryCode | string | No | Country code (auto-detected if not provided) |

**Example Request:**
```bash
curl -X POST {BASE_URL}/whatsapp/register \
  -H "Content-Type: application/json" \
  -d '{"phoneNumber": "+1234567890"}'
```

**Success Response (202 Accepted):**
```json
{
  "success": true,
  "sessionId": "whatsapp_1731948095000_a1b2c3",
  "status": "pending",
  "phoneNumber": "+1234567890",
  "countryCode": "1",
  "message": "Registration initiated. WhatsApp will be prepared for OTP input.",
  "estimatedTime": "2-3 minutes",
  "nextStep": "Check status endpoint, then submit OTP when you receive the SMS"
}
```

**Important:** Save the `sessionId` - you'll need it for all subsequent requests.

**Error Response (400 Bad Request):**
```json
{
  "success": false,
  "error": "Invalid phone number format. Use E.164 format (e.g., +1234567890)"
}
```

**Error Response (503 Service Unavailable):**
```json
{
  "success": false,
  "error": "Emulator is busy with another registration. Please try again in 2-3 minutes.",
  "activeRegistrations": 1
}
```

---

### Step 2: Check Registration Status

**Endpoint:** `GET /whatsapp/status/{sessionId}`

**Example Request:**
```bash
curl {BASE_URL}/whatsapp/status/whatsapp_1731948095000_a1b2c3
```

**Response - Still Processing:**
```json
{
  "success": true,
  "sessionId": "whatsapp_1731948095000_a1b2c3",
  "status": "in_progress",
  "phoneNumber": "+1234567890",
  "countryCode": "1",
  "createdAt": "2025-11-18T17:42:00.000Z",
  "lastUpdated": "2025-11-18T17:42:45.000Z",
  "message": "Registration in progress. Please wait...",
  "hint": "This typically takes 1-2 minutes"
}
```

**Response - Ready for OTP:**
```json
{
  "success": true,
  "sessionId": "whatsapp_1731948095000_a1b2c3",
  "status": "waiting_for_otp",
  "phoneNumber": "+1234567890",
  "countryCode": "1",
  "createdAt": "2025-11-18T17:42:00.000Z",
  "lastUpdated": "2025-11-18T17:43:30.000Z",
  "message": "Ready for OTP. Please submit the 6-digit code via /verify endpoint.",
  "nextStep": "POST /whatsapp/verify with your OTP"
}
```

**Response - Failed:**
```json
{
  "success": true,
  "sessionId": "whatsapp_1731948095000_a1b2c3",
  "status": "failed",
  "phoneNumber": "+1234567890",
  "errorDetails": "Emulator connection lost",
  "hint": "Please start a new registration"
}
```

---

### Step 3: Submit OTP

**Endpoint:** `POST /whatsapp/verify`

**Request Body:**
```json
{
  "sessionId": "whatsapp_1731948095000_a1b2c3",
  "otp": "123456"
}
```

**Parameters:**

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| sessionId | string | Yes | Session ID from registration response |
| otp | string | Yes | 6-digit OTP code (no spaces or dashes) |

**Example Request:**
```bash
curl -X POST {BASE_URL}/whatsapp/verify \
  -H "Content-Type: application/json" \
  -d '{
    "sessionId": "whatsapp_1731948095000_a1b2c3",
    "otp": "123456"
  }'
```

**Success Response:**
```json
{
  "success": true,
  "sessionId": "whatsapp_1731948095000_a1b2c3",
  "status": "verifying",
  "message": "OTP submitted. Verification in progress (15-30 seconds).",
  "phoneNumber": "+1234567890",
  "hint": "Check status endpoint for completion"
}
```

**Error Responses:**

**400 Bad Request:**
```json
{
  "success": false,
  "error": "OTP must be a 6-digit number (e.g., \"123456\")"
}
```

**404 Not Found:**
```json
{
  "success": false,
  "error": "Session not found or expired",
  "hint": "Session may have timed out. Please start a new registration."
}
```

**429 Too Many Requests:**
```json
{
  "success": false,
  "error": "Maximum OTP attempts exceeded (3 attempts)",
  "sessionId": "whatsapp_1731948095000_a1b2c3",
  "hint": "Please start a new registration"
}
```

---

### Step 4: Verify Completion

**Endpoint:** `GET /whatsapp/status/{sessionId}`

Wait 15-30 seconds after submitting OTP, then check status again.

**Example Request:**
```bash
curl {BASE_URL}/whatsapp/status/whatsapp_1731948095000_a1b2c3
```

**Success Response:**
```json
{
  "success": true,
  "sessionId": "whatsapp_1731948095000_a1b2c3",
  "status": "registered",
  "phoneNumber": "+1234567890",
  "countryCode": "1",
  "createdAt": "2025-11-18T17:42:00.000Z",
  "lastUpdated": "2025-11-18T17:45:30.000Z",
  "message": "WhatsApp account successfully registered!",
  "completedAt": "2025-11-18T17:45:30.000Z"
}
```

---

## All Available Endpoints

| Endpoint | Method | Description |
|----------|--------|-------------|
| /health | GET | Check API and services health |
| /whatsapp/register | POST | Start new WhatsApp registration |
| /whatsapp/verify | POST | Submit OTP code for verification |
| /whatsapp/status/:sessionId | GET | Check registration status |
| /whatsapp/cancel/:sessionId | DELETE | Cancel ongoing registration |
| /whatsapp/sessions | GET | List all active sessions |

---

## Additional Endpoints

### Health Check

**Endpoint:** `GET /health`

**Example Request:**
```bash
curl {BASE_URL}/health
```

**Response:**
```json
{
  "success": true,
  "data": {
    "status": "HEALTHY",
    "api": "OK",
    "redis": "OK",
    "appium": "OK",
    "emulator": "OK",
    "timestamp": "2025-11-18T17:41:35.930Z",
    "uptime": 564.87,
    "environment": "development"
  }
}
```

---

### List All Sessions

**Endpoint:** `GET /whatsapp/sessions`

**Example Request:**
```bash
curl {BASE_URL}/whatsapp/sessions
```

**Response:**
```json
{
  "success": true,
  "sessions": [
    {
      "sessionId": "whatsapp_1731948095000_a1b2c3",
      "phoneNumber": "+1234567890",
      "status": "registered",
      "createdAt": "2025-11-18T17:42:00.000Z",
      "lastUpdated": "2025-11-18T17:45:30.000Z"
    },
    {
      "sessionId": "whatsapp_1731948200000_d4e5f6",
      "phoneNumber": "+1234567891",
      "status": "waiting_for_otp",
      "createdAt": "2025-11-18T17:50:00.000Z",
      "lastUpdated": "2025-11-18T17:51:30.000Z"
    }
  ],
  "total": 2,
  "activeRegistrations": 1
}
```

---

### Cancel Registration

**Endpoint:** `DELETE /whatsapp/cancel/{sessionId}`

**Example Request:**
```bash
curl -X DELETE {BASE_URL}/whatsapp/cancel/whatsapp_1731948095000_a1b2c3
```

**Response:**
```json
{
  "success": true,
  "message": "Registration cancelled",
  "sessionId": "whatsapp_1731948095000_a1b2c3"
}
```

---

## Status Codes Reference

| Status | Meaning | Next Action |
|--------|---------|-------------|
| pending | Registration queued | Wait, check status in 10s |
| in_progress | Bot is entering phone number | Wait, check status in 30s |
| waiting_for_otp | Ready for OTP | Submit OTP via /verify |
| verifying | OTP submitted, being verified | Wait, check status in 15s |
| registered | Success | Registration complete |
| failed | Registration failed | Check error, start new registration |
| cancelled | Registration was cancelled | Start new registration if needed |

---

## Timing and Limits

### Expected Timing
- **Registration to OTP ready:** 60-90 seconds
- **OTP submission to completion:** 15-30 seconds
- **Total per account:** 2-3 minutes

### System Limits
- **Concurrent registrations:** 1 (queued processing)
- **OTP expiry:** 10 minutes (WhatsApp limitation)
- **Maximum OTP attempts:** 3 per session
- **Session timeout:** 15 minutes of inactivity
- **Queue capacity:** Unlimited (processed one by one)

---

## Error Handling

### Common Errors and Solutions

| Error | Cause | Solution |
|-------|-------|----------|
| Invalid phone number format | Wrong format | Use E.164: +[country][number] |
| Emulator is busy | Another registration in progress | Wait 2-3 minutes, try again |
| Session not found | Session expired (15 min) | Start new registration |
| Invalid OTP | Wrong code or format | Check phone, use 6 digits only |
| Maximum OTP attempts exceeded | Failed 3 times | Start new registration |
| Cannot verify OTP | Too early | Wait for "waiting_for_otp" status |

### Timeout Scenarios

**If registration takes too long:**
1. Check system health: `GET /health`
2. Check session status: `GET /whatsapp/status/{sessionId}`
3. If stuck for more than 5 minutes, cancel and retry
4. Contact developer if issue persists

---

## Expected Success Rates

Based on testing:
- **Success rate:** 90-95%
- **Common failure reasons:**
  - Invalid phone numbers (5%)
  - Network issues (2-3%)
  - OTP entry errors (2%)

**Note:** Some failures are expected and normal. If success rate drops below 80%, investigate system health.

---

## Best Practices

### For Testing 10-50 Accounts

**1. Prepare in advance**
- Have all phone numbers ready in a list
- Ensure all numbers can receive SMS
- Test with 2-3 accounts first

**2. Monitor progress**
- Use `/whatsapp/sessions` to track all registrations
- Check status every 30-60 seconds
- Keep a log of successes and failures

**3. Handle OTPs efficiently**
- Have phones ready when testing
- Submit OTPs within 10 minutes
- Double-check codes before submitting

**4. Manage queue**
- Only 1 registration processes at a time
- Wait 10 seconds between starting new registrations
- Do not start too many at once

**5. Track results**
- Use the provided PowerShell script
- Or maintain manual log with:
  - Phone number
  - Session ID
  - Start time
  - Status
  - Completion time

---

## Testing Examples

### Example 1: Single Account Registration

```bash
# Step 1: Register
curl -X POST {BASE_URL}/whatsapp/register \
  -H "Content-Type: application/json" \
  -d '{"phoneNumber": "+1234567890"}'

# Response includes sessionId

# Step 2: Wait 90 seconds, then check status
curl {BASE_URL}/whatsapp/status/SESSION_ID

# Wait for status: "waiting_for_otp"

# Step 3: Submit OTP (check your phone first)
curl -X POST {BASE_URL}/whatsapp/verify \
  -H "Content-Type: application/json" \
  -d '{"sessionId": "SESSION_ID", "otp": "123456"}'

# Step 4: Wait 20 seconds, verify completion
curl {BASE_URL}/whatsapp/status/SESSION_ID

# Response should show: "status": "registered"
```

---

### Example 2: Checking System Health

```bash
# Before starting any registrations
curl {BASE_URL}/health

# All services should return "OK"
# If any service shows "FAILED", contact developer
```

---

### Example 3: Managing Multiple Sessions

```bash
# Check all active sessions
curl {BASE_URL}/whatsapp/sessions

# Cancel a session if needed
curl -X DELETE {BASE_URL}/whatsapp/cancel/SESSION_ID
```

---

## Security Notes

- Session IDs are unique and expire after 15 minutes
- No sensitive data is stored permanently
- OTP codes are only used for WhatsApp verification
- All communication should use HTTPS (when using remote URL)

---

## Support and Troubleshooting

### Before Contacting Support

1. Check `/health` endpoint - are all services OK?
2. Check `/whatsapp/status/{sessionId}` - what's the current status?
3. Try cancelling and restarting the registration
4. Check if emulator and API are still running (local setup only)

### When Reporting Issues

Please provide:
- Session ID
- Phone number (last 4 digits only)
- Error message or status
- Steps taken before error
- Screenshot (if applicable)

### Developer Contact

Available for support during testing sessions.

---

## Status Flow Diagram

```
START
  ↓
POST /whatsapp/register
  ↓
status: "pending" (immediately)
  ↓
[Bot starts working - 60-90 seconds]
  ↓
status: "in_progress" (bot entering number)
  ↓
[WhatsApp sends SMS - automatic]
  ↓
status: "waiting_for_otp" 
  ↓
POST /whatsapp/verify (you submit OTP)
  ↓
status: "verifying" (15-30 seconds)
  ↓
status: "registered" - SUCCESS
```

---

## Testing Checklist

Before starting bulk testing:

- [ ] Received API base URL from developer
- [ ] Health check passes (all services "OK")
- [ ] Successfully tested with 1-2 accounts
- [ ] Confirmed OTP submission works
- [ ] Have list of 10-50 phone numbers ready
- [ ] All phones can receive SMS
- [ ] PowerShell script ready (or manual process planned)
- [ ] Decided on testing approach (script vs manual)
- [ ] Developer is available for support

---

**For questions or support, contact the developer.**

**Document Version:** 1.0.0  
**Last Updated:** November 18, 2025